// Terjemahan UI
const uiTranslations = {
    "ID": {
        "title": "Alat Penerjemah Novel",
        "subtitle": "Terjemahkan novel atau teks panjang dengan mudah",
        "ui_lang": "Bahasa Antarmuka:",
        "provider": "Layanan Terjemahan:",
        "src_lang": "Bahasa Sumber:",
        "dest_lang": "Bahasa Target:",
        "translation_style": "Gaya Terjemahan:",
        "style_formal": "Formal/Baku",
        "style_natural": "Natural/Informal",
        "style_novel": "Gaya Novel/Sastra",
        "style_casual": "Santai/Casual",
        "src_text": "Teks Sumber",
        "dest_text": "Hasil Terjemahan",
        "translate": "Terjemahkan",
        "import": "Impor Teks",
        "export": "Ekspor Hasil",
        "clear": "Bersihkan",
        "settings": "Pengaturan",
        "ready": "Siap",
        "translating": "Sedang menerjemahkan...",
        "complete": "Terjemahan selesai",
        "error": "Error terjadi",
        "cleared": "Teks telah dibersihkan",
        "file_loaded": "File dimuat: ",
        "file_saved": "File disimpan: ",
        "no_text": "Tidak ada teks untuk diterjemahkan!",
        "chars": "karakter",
        "api_key_required": "API key diperlukan untuk layanan ini",
        "api_error": "Error API: ",
        "network_error": "Error jaringan: "
    },
    "EN": {
        "title": "Novel Translation Tool",
        "subtitle": "Easily translate novels or long texts",
        "ui_lang": "UI Language:",
        "provider": "Translation Provider:",
        "src_lang": "Source Language:",
        "dest_lang": "Target Language:",
        "translation_style": "Translation Style:",
        "style_formal": "Formal",
        "style_natural": "Natural/Informal",
        "style_novel": "Novel/Literary",
        "style_casual": "Casual",
        "src_text": "Source Text",
        "dest_text": "Translated Result",
        "translate": "Translate",
        "import": "Import Text",
        "export": "Export Result",
        "clear": "Clear",
        "settings": "Settings",
        "ready": "Ready",
        "translating": "Translating...",
        "complete": "Translation complete",
        "error": "Error occurred",
        "cleared": "Text cleared",
        "file_loaded": "File loaded: ",
        "file_saved": "File saved: ",
        "no_text": "No text to translate!",
        "chars": "characters",
        "api_key_required": "API key required for this service",
        "api_error": "API Error: ",
        "network_error": "Network Error: "
    },
    "JP": {
        "title": "小説翻訳ツール",
        "subtitle": "小説や長文を簡単に翻訳",
        "ui_lang": "UIの言語:",
        "provider": "翻訳プロバイダー:",
        "src_lang": "元の言語:",
        "dest_lang": "目標言語:",
        "translation_style": "翻訳スタイル:",
        "style_formal": "正式/標準",
        "style_natural": "自然/くだけた",
        "style_novel": "小説/文学的",
        "style_casual": "カジュアル",
        "src_text": "元のテキスト",
        "dest_text": "翻訳結果",
        "translate": "翻訳",
        "import": "テキストをインポート",
        "export": "結果をエクスポート",
        "clear": "クリア",
        "settings": "設定",
        "ready": "準備完了",
        "translating": "翻訳中...",
        "complete": "翻訳完了",
        "error": "エラーが発生しました",
        "cleared": "テキストをクリアしました",
        "file_loaded": "ファイルを読み込み: ",
        "file_saved": "ファイルを保存: ",
        "no_text": "翻訳するテキストがありません!",
        "chars": "文字",
        "api_key_required": "このサービスにはAPIキーが必要です",
        "api_error": "APIエラー: ",
        "network_error": "ネットワークエラー: "
    },
    "KR": {
        "title": "소설 번역 도구",
        "subtitle": "소설이나 긴 글을 쉽게 번역",
        "ui_lang": "UI 언어:",
        "provider": "번역 제공자:",
        "src_lang": "원본 언어:",
        "dest_lang": "목표 언어:",
        "translation_style": "번역 스타일:",
        "style_formal": "공식/표준",
        "style_natural": "자연스러움/비공식",
        "style_novel": "소설/문학적",
        "style_casual": "캐주얼",
        "src_text": "원본 텍스트",
        "dest_text": "번역 결과",
        "translate": "번역",
        "import": "텍스트 가져오기",
        "export": "결과 내보내기",
        "clear": "지우기",
        "settings": "설정",
        "ready": "준비 완료",
        "translating": "번역 중...",
        "complete": "번역 완료",
        "error": "오류 발생",
        "cleared": "텍스트 지움",
        "file_loaded": "파일 불러옴: ",
        "file_saved": "파일 저장: ",
        "no_text": "번역할 텍스트가 없습니다!",
        "chars": "글자",
        "api_key_required": "이 서비스에는 API 키가 필요합니다",
        "api_error": "API 오류: ",
        "network_error": "네트워크 오류: "
    },
    "CN": {
        "title": "小说翻译工具",
        "subtitle": "轻松翻译小说或长文本",
        "ui_lang": "界面语言:",
        "provider": "翻译提供商:",
        "src_lang": "源语言:",
        "dest_lang": "目标语言:",
        "translation_style": "翻译风格:",
        "style_formal": "正式/标准",
        "style_natural": "自然/非正式",
        "style_novel": "小说/文学",
        "style_casual": "随意",
        "src_text": "源文本",
        "dest_text": "翻译结果",
        "translate": "翻译",
        "import": "导入文本",
        "export": "导出结果",
        "clear": "清除",
        "settings": "设置",
        "ready": "准备就绪",
        "translating": "翻译中...",
        "complete": "翻译完成",
        "error": "发生错误",
        "cleared": "文本已清除",
        "file_loaded": "文件已加载: ",
        "file_saved": "文件已保存: ",
        "no_text": "没有要翻译的文本!",
        "chars": "字符",
        "api_key_required": "此服务需要API密钥",
        "api_error": "API错误: ",
        "network_error": "网络错误: "
    }
};

// Teks contoh untuk berbagai bahasa
const sampleTexts = {
    "JP": "吾輩は猫である。名前はまだ無い。どこで生れたかとんと見当がつかぬ。何でも薄暗いじめじめした所でニャーニャー泣いていた事だけは記憶している。",
    "KR": "나는 고양이로소이다. 이름은 아직 없다. 어디에서 태어났는지 전혀 짐작이 안 간다. 다만 어둡고 축축한 곳에서 야옹야옹 울고 있던 것만은 기억하고 있다。",
    "CN": "我是猫。名字还没有。出生在哪里一点都估计不到。只记得在阴暗潮湿的地方喵喵地哭过。",
    "EN": "I am a cat. I don't have a name yet. I have no idea where I was born. I only remember meowing in a dark, damp place.",
    "ID": "Saya adalah kucing. Belum punya nama. Sama sekali tidak tahu di mana saya dilahirkan. Saya hanya ingat mengeong di tempat yang gelap dan lembab."
};

// Aturan untuk naturalisasi terjemahan berdasarkan bahasa target
const naturalizationRules = {
    'id': {
        formalToNatural: [
            // Kata ganti orang
            {from: /\bsaya\b/gi, to: 'aku'},
            {from: /\banda\b/gi, to: 'kamu'},
            {from: /\bbeliau\b/gi, to: 'dia'},
            {from: /\bmereka\b/gi, to: 'mereka'},
            {from: /\bkami\b/gi, to: 'kita'},
            
            // Kata kerja formal ke informal
            {from: /\bmengatakan\b/gi, to: 'bilang'},
            {from: /\bmemberikan\b/gi, to: 'kasih'},
            {from: /\bmenggunakan\b/gi, to: 'pake'},
            {from: /\bmempunyai\b/gi, to: 'punya'},
            {from: /\bmelakukan\b/gi, to: 'ngerjain'},
            {from: /\bmelihat\b/gi, to: 'liat'},
            {from: /\bmemanggil\b/gi, to: 'panggil'},
            {from: /\bmeminta\b/gi, to: 'minta'},
            {from: /\bmeminum\b/gi, to: 'minum'},
            {from: /\bmemakan\b/gi, to: 'makan'},
            
            // Struktur kalimat
            {from: /\bapakah\b/gi, to: 'apa'},
            {from: /\bsedang\b/gi, to: 'lagi'},
            {from: /\bterdapat\b/gi, to: 'ada'},
            {from: /\bterletak\b/gi, to: 'ada di'},
            {from: /\boleh karena itu\b/gi, to: 'jadi'},
            {from: /\bmeskipun demikian\b/gi, to: 'tapi'},
            
            // Partikel
            {from: /(\w)\s\bkah\b/gi, to: '$1'},
            
            // Tambahan untuk gaya novel
            {from: /\bpria\b/gi, to: 'laki-laki'},
            {from: /\bwanita\b/gi, to: 'perempuan'},
            {from: /\btersenyum\b/gi, to: 'senyum'},
            {from: /\bberkata\b/gi, to: 'kata'},
            {from: /\bberjalan\b/gi, to: 'jalan'},
            {from: /\bmemandang\b/gi, to: 'pandang'},
        ],
        novelStyle: [
            // Untuk gaya novel/sastra
            {from: /\baku\b/gi, to: 'aku'},
            {from: /\bdia\b/gi, to: 'ia'},
            {from: /\bmelihat\b/gi, to: 'memandang'},
            {from: /\bpergi\b/gi, to: 'beranjak'},
            {from: /\bbicara\b/gi, to: 'berucap'},
            {from: /\bcepat\b/gi, to: 'cekat'},
            {from: /\blambat\b/gi, to: 'perlahan'},
            {from: /\bmatahari\b/gi, to: 'mentari'},
            {from: /\bbulan\b/gi, to: 'rembulan'},
            {from: /\bmalam\b/gi, to: 'malam hari'},
            {from: /\bsiang\b/gi, to: 'siang hari'},
        ],
        casualStyle: [
            // Untuk gaya sangat santai
            {from: /\baku\b/gi, to: 'gue'},
            {from: /\bkamu\b/gi, to: 'lu'},
            {from: /\bsaya\b/gi, to: 'gue'},
            {from: /\banda\b/gi, to: 'lu'},
            {from: /\btidak\b/gi, to: 'nggak'},
            {from: /\bsudah\b/gi, to: 'udah'},
            {from: /\bingin\b/gi, to: 'pengen'},
            {from: /\bsekali\b/gi, to: 'banget'},
            {from: /\bada\b/gi, to: 'ada'},
            {from: /\bsedang\b/gi, to: 'lagi'},
            {from: /\bmau\b/gi, to: 'kepingin'},
            {from: /\bpergi\b/gi, to: 'pergi'},
        ]
    },
    'en': {
        formalToNatural: [
            // Pronouns
            {from: /\bone\b/gi, to: 'you'},
            {from: /\bthis individual\b/gi, to: 'this person'},
            
            // Formal to informal
            {from: /\bcommence\b/gi, to: 'start'},
            {from: /\bterminate\b/gi, to: 'end'},
            {from: /\butilize\b/gi, to: 'use'},
            {from: /\bapproximately\b/gi, to: 'about'},
            {from: /\badditional\b/gi, to: 'more'},
            {from: /\bassist\b/gi, to: 'help'},
            {from: /\brequest\b/gi, to: 'ask'},
            {from: /\binquire\b/gi, to: 'ask'},
            {from: /\breside\b/gi, to: 'live'},
            {from: /\bpossess\b/gi, to: 'have'},
            {from: /\bobtain\b/gi, to: 'get'},
            {from: /\bpurchase\b/gi, to: 'buy'},
            {from: /\bconstruct\b/gi, to: 'build'},
            {from: /\bfabricate\b/gi, to: 'make'},
            
            // Sentence structures
            {from: /\bin order to\b/gi, to: 'to'},
            {from: /\bwith regard to\b/gi, to: 'about'},
            {from: /\bdue to the fact that\b/gi, to: 'because'},
            {from: /\bprior to\b/gi, to: 'before'},
            {from: /\bsubsequent to\b/gi, to: 'after'},
            {from: /\bin the event that\b/gi, to: 'if'},
            {from: /\bwith reference to\b/gi, to: 'about'},
            {from: /\bon the occasion of\b/gi, to: 'when'},
            {from: /\bfor the purpose of\b/gi, to: 'to'},
            {from: /\bin the vicinity of\b/gi, to: 'near'},
            {from: /\bat this point in time\b/gi, to: 'now'},
            {from: /\bin the near future\b/gi, to: 'soon'},
            {from: /\btake into consideration\b/gi, to: 'consider'},
            {from: /\barrive at a decision\b/gi, to: 'decide'},
            {from: /\bconduct an investigation\b/gi, to: 'investigate'},
        ],
        novelStyle: [
            // For novel/literary style
            {from: /\bsaid\b/gi, to: 'whispered'},
            {from: /\bwalked\b/gi, to: 'strolled'},
            {from: /\blooked\b/gi, to: 'gazed'},
            {from: /\bran\b/gi, to: 'dashed'},
            {from: /\bcried\b/gi, to: 'wept'},
            {from: /\blaughed\b/gi, to: 'chuckled'},
            {from: /\bsun\b/gi, to: 'sun'},
            {from: /\bmoon\b/gi, to: 'moon'},
            {from: /\bhouse\b/gi, to: 'dwelling'},
            {from: /\bcar\b/gi, to: 'automobile'},
            {from: /\bman\b/gi, to: 'gentleman'},
            {from: /\bwoman\b/gi, to: 'lady'},
            {from: /\bchild\b/gi, to: 'young one'},
            {from: /\bold\b/gi, to: 'elderly'},
            {from: /\byoung\b/gi, to: 'youthful'},
        ],
        casualStyle: [
            // For very casual style
            {from: /\bgoing to\b/gi, to: 'gonna'},
            {from: /\bwant to\b/gi, to: 'wanna'},
            {from: /\bhave to\b/gi, to: 'hafta'},
            {from: /\bgot to\b/gi, to: 'gotta'},
            {from: /\bkind of\b/gi, to: 'kinda'},
            {from: /\bsort of\b/gi, to: 'sorta'},
            {from: /\bout of\b/gi, to: 'outta'},
            {from: /\bdon't know\b/gi, to: 'dunno'},
            {from: /\bwhat are you\b/gi, to: 'whatcha'},
            {from: /\blet me\b/gi, to: 'lemme'},
            {from: /\bgive me\b/gi, to: 'gimme'},
            {from: /\bbecause\b/gi, to: "'cause"},
            {from: /\bprobably\b/gi, to: 'prolly'},
            {from: /\bawesome\b/gi, to: 'cool'},
            {from: /\bexcellent\b/gi, to: 'rad'},
        ]
    },
    'ja': {
        formalToNatural: [
            // Formal to informal Japanese
            {from: /です/gi, to: 'だ'},
            {from: /ます/gi, to: ''},
            {from: /ございます/gi, to: 'ある'},
            {from: /でしょうか/gi, to: 'かな'},
            {from: /いたします/gi, to: 'する'},
            {from: /申し上げます/gi, to: '言う'},
            {from: /いただきます/gi, to: 'もらう'},
            {from: /させていただきます/gi, to: 'する'},
            
            // Pronouns
            {from: /私/gi, to: '僕'},
            {from: /わたし/gi, to: 'ぼく'},
            {from: /わたくし/gi, to: 'ぼく'},
            {from: /あなた/gi, to: '君'},
            {from: /あんた/gi, to: 'きみ'},
            
            // Sentence endings
            {from: /ませんか/gi, to: 'ないか'},
            {from: /ましょう/gi, to: 'う'},
            {from: /ですね/gi, to: 'だね'},
        ],
        novelStyle: [
            // For novel/literary style
            {from: /言った/gi, to: '囁いた'},
            {from: /歩いた/gi, to: '歩みを進めた'},
            {from: /見た/gi, to: '見つめた'},
            {from: /走った/gi, to: '駆けだした'},
            {from: /家/gi, to: '住まい'},
            {from: /男/gi, to: '男性'},
            {from: /女/gi, to: '女性'},
            {from: /子供/gi, to: '幼子'},
        ]
    },
    'ko': {
        formalToNatural: [
            // Formal to informal Korean
            {from: /입니다/gi, to: '이야'},
            {from: /입니까/gi, to: '이야'},
            {from: /합니다/gi, to: '해'},
            {from: /하십시오/gi, to: '해'},
            {from: /께서/gi, to: '가'},
            {from: /에게서/gi, to: '한테서'},
            
            // Pronouns
            {from: /저/gi, to: '나'},
            {from: /제/gi, to: '내'},
            {from: /당신/gi, to: '너'},
            
            // Honorifics to plain
            {from: /드리다/gi, to: '주다'},
            {from: /뵙다/gi, to: '보다'},
            {from: /말씀/gi, to: '말'},
        ],
        novelStyle: [
            // For novel/literary style
            {from: /말했다/gi, to: '속삭였다'},
            {from: /걸었다/gi, to: '거닐었다'},
            {from: /보았다/gi, to: '바라보았다'},
            {from: /달렸다/gi, to: '내달렸다'},
            {from: /집/gi, to: '주거'},
            {from: /남자/gi, to: '남성'},
            {from: /여자/gi, to: '여성'},
            {from: /아이/gi, to: '어린이'},
        ]
    },
    'zh': {
        formalToNatural: [
            // Formal to informal Chinese
            {from: /您/gi, to: '你'},
            {from: /请问/gi, to: '问一下'},
            {from: /感谢/gi, to: '谢谢'},
            {from: /抱歉/gi, to: '对不起'},
            {from: /能否/gi, to: '能不能'},
            {from: /为何/gi, to: '为什么'},
            {from: /如何/gi, to: '怎么'},
            {from: /之后/gi, to: '以后'},
            {from: /之前/gi, to: '以前'},
            
            // Sentence structures
            {from: /是否/gi, to: '是不是'},
            {from: /将会/gi, to: '会'},
            {from: /应当/gi, to: '应该'},
        ],
        novelStyle: [
            // For novel/literary style
            {from: /说/gi, to: '道'},
            {from: /走/gi, to: '踱步'},
            {from: /看/gi, to: '凝视'},
            {from: /跑/gi, to: '奔跑'},
            {from: /房子/gi, to: '宅邸'},
            {from: /男人/gi, to: '男子'},
            {from: /女人/gi, to: '女子'},
            {from: /孩子/gi, to: '孩童'},
        ]
    }
};

// Fungsi untuk memperbaiki kapitalisasi teks
function fixCapitalization(text) {
    if (!text || text.length === 0) return text;
    
    // Pisahkan teks menjadi kalimat-kalimat
    const sentences = text.split(/([.!?]+\s*)/);
    let result = '';
    
    for (let i = 0; i < sentences.length; i++) {
        let sentence = sentences[i];
        
        // Jika ini adalah pemisah kalimat (., !, ?), tambahkan ke hasil dan lanjutkan
        if (/[.!?]+\s*$/.test(sentence) && i < sentences.length - 1) {
            result += sentence;
            continue;
        }
        
        // Jika kalimat kosong, lanjutkan
        if (sentence.trim().length === 0) {
            result += sentence;
            continue;
        }
        
        // Kapitalisasi huruf pertama kalimat
        let formattedSentence = sentence.charAt(0).toUpperCase() + sentence.slice(1);
        
        // Perbaiki kapitalisasi "i" menjadi "I" dalam bahasa Inggris
        if (document.getElementById('target-language').value === 'en') {
            formattedSentence = formattedSentence.replace(/\bi\b/g, 'I');
        }
        
        result += formattedSentence;
    }
    
    return result;
}

// Fungsi untuk mendeteksi dan mempertahankan pola kapitalisasi asli
function preserveCapitalization(originalText, translatedText) {
    if (!originalText || !translatedText) return translatedText;
    
    // Deteksi jika teks asli seluruhnya huruf besar
    if (originalText === originalText.toUpperCase()) {
        return translatedText.toUpperCase();
    }
    
    // Deteksi jika teks asli seluruhnya huruf kecil
    if (originalText === originalText.toLowerCase()) {
        return translatedText.toLowerCase();
    }
    
    // Deteksi jika teks asli menggunakan title case (setiap kata dimulai dengan huruf besar)
    const words = originalText.split(/\s+/);
    const isTitleCase = words.length > 1 && words.every(word => {
        if (word.length === 0) return true;
        const firstChar = word[0];
        return firstChar === firstChar.toUpperCase() && firstChar !== firstChar.toLowerCase();
    });
    
    if (isTitleCase) {
        return translatedText.split(/\s+/).map(word => {
            if (word.length === 0) return word;
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }).join(' ');
    }
    
    return translatedText;
}

// Fungsi untuk memperbaiki spasi sekitar tanda baca
function fixPunctuationSpacing(text) {
    if (!text) return text;
    
    // Perbaiki spasi sebelum tanda baca
    let formattedText = text
        .replace(/\s+([.,!?;:])/g, '$1') // Hapus spasi sebelum tanda baca
        .replace(/([.,!?;:])([A-Za-z0-9])/g, '$1 $2'); // Tambahkan spasi setelah tanda baca jika tidak ada
    
    // Perbaiki spasi sekitar tanda kutip
    formattedText = formattedText
        .replace(/\s+(["'])\s*/g, '$1') // Spasi sebelum kutip
        .replace(/(["'])\s+/g, '$1'); // Spasi setelah kutip
    
    return formattedText;
}

// Fungsi untuk menangani kasus khusus seperti singkatan
function handleSpecialCases(text, targetLang) {
    if (!text) return text;
    
    let formattedText = text;
    
    // Daftar singkatan umum yang tidak boleh diubah
    const abbreviations = {
        'en': ['Mr.', 'Mrs.', 'Dr.', 'Prof.', 'etc.', 'e.g.', 'i.e.', 'vs.', 'Jan.', 'Feb.', 'Mar.'],
        'id': ['Tn.', 'Ny.', 'Dr.', 'Prof.', 'dll.', 'dkk.', 'dst.', 'dgn.', 'yg.', 'dpt.'],
        'ja': ['さん', '様', '先生', '博士'],
        'ko': ['씨', '님', '선생', '박사'],
        'zh': ['先生', '女士', '博士', '教授']
    };
    
    // Untuk setiap bahasa, lindungi singkatan dari perubahan kapitalisasi
    if (abbreviations[targetLang]) {
        abbreviations[targetLang].forEach(abbr => {
            const regex = new RegExp(`\\b${abbr}\\b`, 'gi');
            formattedText = formattedText.replace(regex, abbr);
        });
    }
    
    // Perbaiki kapitalisasi untuk nama bulan dan hari (bahasa Inggris)
    if (targetLang === 'en') {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        
        months.forEach(month => {
            const regex = new RegExp(`\\b${month.toLowerCase()}\\b`, 'g');
            formattedText = formattedText.replace(regex, month);
        });
        
        days.forEach(day => {
            const regex = new RegExp(`\\b${day.toLowerCase()}\\b`, 'g');
            formattedText = formattedText.replace(regex, day);
        });
    }
    
    return formattedText;
}

// Fungsi untuk membuat terjemahan lebih natural
function naturalizeTranslation(text, targetLang, style) {
    if (style === 'formal') {
        return text; // Pertahankan terjemahan formal
    }
    
    if (!naturalizationRules[targetLang]) {
        return text; // Tidak ada aturan untuk bahasa ini
    }
    
    let naturalizedText = text;
    const rules = naturalizationRules[targetLang];
    
    // Terapkan aturan berdasarkan gaya yang dipilih
    if (style === 'natural' || style === 'casual') {
        if (rules.formalToNatural) {
            rules.formalToNatural.forEach(rule => {
                naturalizedText = naturalizedText.replace(rule.from, rule.to);
            });
        }
    }
    
    if (style === 'novel' && rules.novelStyle) {
        rules.novelStyle.forEach(rule => {
            naturalizedText = naturalizedText.replace(rule.from, rule.to);
        });
    }
    
    if (style === 'casual' && rules.casualStyle) {
        rules.casualStyle.forEach(rule => {
            naturalizedText = naturalizedText.replace(rule.from, rule.to);
        });
    }
    
    // Untuk bahasa Indonesia, tambahkan transformasi khusus
    if (targetLang === 'id') {
        if (style === 'casual') {
            naturalizedText = naturalizedText
                .replace(/\b(sudah|telah)\b/gi, 'udah')
                .replace(/\b(ingin)\b/gi, 'pengen')
                .replace(/\b(sekali)\b/gi, 'banget')
                .replace(/\b(tidak)\b/gi, 'nggak')
                .replace(/\b(ada)\b/gi, 'ada')
                .replace(/\b(sedang)\b/gi, 'lagi')
                .replace(/\b(akan)\b/gi, 'bakal')
                .replace(/\b(pergi)\b/gi, 'pergi')
                .replace(/\b(besar)\b/gi, 'gede')
                .replace(/\b(kecil)\b/gi, 'kecil');
        }
        
        // Untuk semua gaya non-formal, lakukan penyederhanaan
        if (style !== 'formal') {
            naturalizedText = naturalizedText
                .replace(/\b(yang)\b/gi, 'yang')
                .replace(/\b(di)\b/gi, 'di')
                .replace(/\b(ke)\b/gi, 'ke')
                .replace(/\b(dari)\b/gi, 'dari')
                .replace(/\bdengan\b/gi, 'sama')
                .replace(/\buntuk\b/gi, 'buat');
        }
    }
    
    return naturalizedText;
}

// Modifikasi fungsi callTranslationAPI untuk menyertakan gaya terjemahan
async function callTranslationAPI(provider, text, sourceLang, targetLang, apiKey = null) {
    const translationStyle = document.getElementById('translation-style').value;
    let translatedText;
    
    switch (provider) {
        case 'google':
            translatedText = await translateWithGoogle(text, sourceLang, targetLang);
            break;
        case 'deepl':
            translatedText = await translateWithDeepL(text, sourceLang, targetLang, apiKey);
            break;
        case 'openai':
            // Untuk OpenAI, kita bisa meminta gaya terjemahan spesifik langsung di prompt
            translatedText = await translateWithOpenAI(text, sourceLang, targetLang, apiKey, translationStyle);
            break;
        case 'claude':
            translatedText = await translateWithClaude(text, sourceLang, targetLang, apiKey, translationStyle);
            break;
        case 'gemini':
            translatedText = await translateWithGemini(text, sourceLang, targetLang, apiKey, translationStyle);
            break;
        case 'microsoft':
            translatedText = await translateWithMicrosoft(text, sourceLang, targetLang, apiKey);
            break;
        default:
            throw new Error('Provider tidak dikenali');
    }
    
    // Terapkan naturalisasi untuk provider yang tidak mendukung gaya terjemahan langsung
    if (provider !== 'openai' && provider !== 'claude' && provider !== 'gemini') {
        translatedText = naturalizeTranslation(translatedText, targetLang, translationStyle);
    }
    
    // Pertahankan pola kapitalisasi dari teks asli
    translatedText = preserveCapitalization(text, translatedText);
    
    // Perbaiki kapitalisasi kalimat
    translatedText = fixCapitalization(translatedText);
    
    // Perbaiki spasi tanda baca
    translatedText = fixPunctuationSpacing(translatedText);
    
    // Tangani kasus khusus seperti singkatan
    translatedText = handleSpecialCases(translatedText, targetLang);
    
    return translatedText;
}

// Modifikasi fungsi translateWithOpenAI untuk menerima parameter gaya
async function translateWithOpenAI(text, sourceLang, targetLang, apiKey, style = 'natural') {
    if (!apiKey) {
        throw new Error(uiTranslations[currentUILang].api_key_required);
    }
    
    const styleInstructions = {
        'formal': 'Translate formally and accurately, maintaining a professional tone. Use proper grammar and avoid contractions.',
        'natural': 'Translate naturally and conversationally, as a native speaker would speak. Use informal pronouns and casual expressions where appropriate. Make it sound human and engaging.',
        'novel': 'Translate in a literary style suitable for novels. Use expressive language, rich vocabulary, and maintain the artistic quality of the text. Create vivid imagery and emotional resonance.',
        'casual': 'Translate in a very casual, colloquial style. Use slang, contractions, and everyday expressions as appropriate. Make it sound like natural spoken language.'
    };
    
    const url = 'https://api.openai.com/v1/chat/completions';
    const prompt = `Translate the following text from ${sourceLang} to ${targetLang} in a ${style} style:\n\n${text}`;
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-3.5-turbo',
                messages: [
                    {
                        role: 'system',
                        content: `You are a professional translator. ${styleInstructions[style]}`
                    },
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 2000,
                temperature: style === 'formal' ? 0.3 : 0.7
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content.trim();
    } catch (error) {
        console.error('OpenAI API error:', error);
        throw new Error(uiTranslations[currentUILang].api_error + error.message);
    }
}

// Modifikasi fungsi translateWithClaude untuk menerima parameter gaya
async function translateWithClaude(text, sourceLang, targetLang, apiKey, style = 'natural') {
    if (!apiKey) {
        throw new Error(uiTranslations[currentUILang].api_key_required);
    }
    
    const styleInstructions = {
        'formal': 'Translate formally and accurately, maintaining a professional tone.',
        'natural': 'Translate naturally and conversationally, as a native speaker would speak.',
        'novel': 'Translate in a literary style suitable for novels.',
        'casual': 'Translate in a very casual, colloquial style.'
    };
    
    const url = 'https://api.anthropic.com/v1/messages';
    const prompt = `Translate the following text from ${sourceLang} to ${targetLang} in a ${style} style:\n\n${text}\n\n${styleInstructions[style]}`;
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
                model: 'claude-3-sonnet-20240229',
                max_tokens: 2000,
                messages: [
                    {
                        role: 'user',
                        content: prompt
                    }
                ]
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.content[0].text;
    } catch (error) {
        console.error('Claude API error:', error);
        throw new Error(uiTranslations[currentUILang].api_error + error.message);
    }
}

// Modifikasi fungsi translateWithGemini untuk menerima parameter gaya
async function translateWithGemini(text, sourceLang, targetLang, apiKey, style = 'natural') {
    if (!apiKey) {
        throw new Error(uiTranslations[currentUILang].api_key_required);
    }
    
    const styleInstructions = {
        'formal': 'Translate formally and accurately.',
        'natural': 'Translate naturally and conversationally.',
        'novel': 'Translate in a literary style suitable for novels.',
        'casual': 'Translate in a very casual, colloquial style.'
    };
    
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
    const prompt = `Translate the following text from ${sourceLang} to ${targetLang} in a ${style} style:\n\n${text}\n\n${styleInstructions[style]}`;
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [
                    {
                        parts: [
                            {
                                text: prompt
                            }
                        ]
                    }
                ],
                generationConfig: {
                    temperature: style === 'formal' ? 0.3 : 0.7,
                    maxOutputTokens: 2000
                }
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.candidates[0].content.parts[0].text.trim();
    } catch (error) {
        console.error('Gemini API error:', error);
        throw new Error(uiTranslations[currentUILang].api_error + error.message);
    }
}

async function translateWithGoogle(text, sourceLang, targetLang) {
    // Google Translate API (menggunakan endpoint publik)
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data[0].map(item => item[0]).join('');
    } catch (error) {
        console.error('Google Translate error:', error);
        throw new Error(uiTranslations[currentUILang].api_error + error.message);
    }
}

async function translateWithDeepL(text, sourceLang, targetLang, apiKey) {
    if (!apiKey) {
        throw new Error(uiTranslations[currentUILang].api_key_required);
    }
    
    // DeepL API
    const url = 'https://api-free.deepl.com/v2/translate';
    const params = new URLSearchParams({
        auth_key: apiKey,
        text: text,
        source_lang: sourceLang.toUpperCase(),
        target_lang: targetLang.toUpperCase()
    });
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: params
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.translations[0].text;
    } catch (error) {
        console.error('DeepL API error:', error);
        throw new Error(uiTranslations[currentUILang].api_error + error.message);
    }
}

async function translateWithMicrosoft(text, sourceLang, targetLang, apiKey) {
    if (!apiKey) {
        throw new Error(uiTranslations[currentUILang].api_key_required);
    }
    
    // Microsoft Translator API
    // Catatan: Untuk menggunakan API ini, Anda perlu membuat resource di Azure
    const region = 'eastus'; // Ganti dengan region Anda
    const url = `https://api.cognitive.microsofttranslator.com/translate?api-version=3.0&from=${sourceLang}&to=${targetLang}`;
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Ocp-Apim-Subscription-Key': apiKey,
                'Ocp-Apim-Subscription-Region': region,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify([{ Text: text }])
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data[0].translations[0].text;
    } catch (error) {
        console.error('Microsoft Translator API error:', error);
        throw new Error(uiTranslations[currentUILang].api_error + error.message);
    }
}

// Variabel global
let currentUILang = "ID";

// Inisialisasi aplikasi
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    // Setup event listeners
    document.getElementById('ui-language').addEventListener('change', updateUILanguage);
    document.getElementById('translate-btn').addEventListener('click', startTranslation);
    document.getElementById('swap-languages').addEventListener('click', swapLanguages);
    document.getElementById('import-btn').addEventListener('click', () => document.getElementById('file-input').click());
    document.getElementById('export-btn').addEventListener('click', exportText);
    document.getElementById('clear-btn').addEventListener('click', clearText);
    document.getElementById('file-input').addEventListener('change', importText);
    document.getElementById('source-text').addEventListener('input', updateCharCount);
    document.getElementById('settings-btn').addEventListener('click', showSettings);
    document.getElementById('toggle-api-key').addEventListener('click', toggleApiKeyVisibility);
    document.querySelector('.close').addEventListener('click', closeSettings);
    
    // Close modal ketika klik di luar konten
    window.addEventListener('click', function(event) {
        if (event.target === document.getElementById('settings-modal')) {
            closeSettings();
        }
    });
    
    // Sample text buttons
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const lang = this.getAttribute('data-lang');
            loadSampleText(lang);
        });
    });
    
    // Load saved API key jika ada
    const savedApiKey = localStorage.getItem('novel_translator_api_key');
    if (savedApiKey) {
        document.getElementById('api-key').value = savedApiKey;
    }
    
    // Set bahasa UI default
    updateUILanguage();
    updateCharCount();
}

function updateUILanguage() {
    currentUILang = document.getElementById('ui-language').value;
    const texts = uiTranslations[currentUILang];
    
    // Update UI texts
    document.querySelector('header h1').textContent = texts.title;
    document.querySelector('header p').textContent = texts.subtitle;
    document.querySelector('label[for="ui-language"]').textContent = texts.ui_lang;
    document.querySelector('label[for="api-provider"]').textContent = texts.provider;
    document.querySelector('label[for="source-language"]').textContent = texts.src_lang;
    document.querySelector('label[for="target-language"]').textContent = texts.dest_lang;
    document.querySelector('label[for="translation-style"]').textContent = texts.translation_style;
    document.querySelector('label[for="source-text"]').textContent = texts.src_text;
    document.querySelector('label[for="target-text"]').textContent = texts.dest_text;
    document.getElementById('translate-btn').innerHTML = `<i class="fas fa-exchange-alt"></i> ${texts.translate}`;
    document.getElementById('import-btn').innerHTML = `<i class="fas fa-file-import"></i> ${texts.import}`;
    document.getElementById('export-btn').innerHTML = `<i class="fas fa-file-export"></i> ${texts.export}`;
    document.getElementById('clear-btn').innerHTML = `<i class="fas fa-broom"></i> ${texts.clear}`;
    document.getElementById('settings-btn').innerHTML = `<i class="fas fa-cog"></i> ${texts.settings}`;
    
    // Update opsi dropdown gaya terjemahan
    const styleSelect = document.getElementById('translation-style');
    styleSelect.innerHTML = `
        <option value="formal">${texts.style_formal}</option>
        <option value="natural" selected>${texts.style_natural}</option>
        <option value="novel">${texts.style_novel}</option>
        <option value="casual">${texts.style_casual}</option>
    `;
    
    // Update placeholder texts
    document.getElementById('source-text').placeholder = currentUILang === 'ID' 
        ? 'Masukkan teks yang ingin diterjemahkan...' 
        : 'Enter text to translate...';
    
    document.getElementById('target-text').placeholder = currentUILang === 'ID' 
        ? 'Hasil terjemahan akan muncul di sini...' 
        : 'Translated result will appear here...';
    
    document.getElementById('api-key').placeholder = currentUILang === 'ID' 
        ? 'Masukkan API key jika diperlukan' 
        : 'Enter API key if required';
    
    // Update status jika dalam keadaan default
    if (document.getElementById('status-bar').textContent === 'Siap' || 
        document.getElementById('status-bar').textContent === 'Ready') {
        document.getElementById('status-bar').textContent = texts.ready;
    }
    
    updateCharCount();
}

function updateCharCount() {
    const sourceText = document.getElementById('source-text').value;
    const targetText = document.getElementById('target-text').value;
    const charsText = uiTranslations[currentUILang].chars;
    
    document.getElementById('source-char-count').textContent = 
        `${sourceText.length} ${charsText}`;
    document.getElementById('target-char-count').textContent = 
        `${targetText.length} ${charsText}`;
}

function loadSampleText(lang) {
    document.getElementById('source-text').value = sampleTexts[lang];
    
    // Set bahasa sumber sesuai dengan sample
    const langMap = {
        "JP": "ja", "KR": "ko", "CN": "zh", "EN": "en", "ID": "id"
    };
    
    document.getElementById('source-language').value = langMap[lang];
    updateCharCount();
    
    // Update status
    document.getElementById('status-bar').textContent = 
        `${uiTranslations[currentUILang].file_loaded} ${lang} Sample`;
}

async function startTranslation() {
    const sourceText = document.getElementById('source-text').value.trim();
    const sourceLang = document.getElementById('source-language').value;
    const targetLang = document.getElementById('target-language').value;
    const apiProvider = document.getElementById('api-provider').value;
    const apiKey = document.getElementById('api-key').value;
    
    if (!sourceText) {
        alert(uiTranslations[currentUILang].no_text);
        return;
    }
    
    // Simpan API key jika checkbox dicentang
    if (document.getElementById('save-api-key').checked && apiKey) {
        localStorage.setItem('novel_translator_api_key', apiKey);
    }
    
    // Disable button dan show progress
    document.getElementById('translate-btn').disabled = true;
    document.getElementById('progress-container').style.display = 'block';
    document.getElementById('progress-text').textContent = uiTranslations[currentUILang].translating;
    document.getElementById('status-bar').textContent = uiTranslations[currentUILang].translating;
    
    // Simulasi progress bar
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 2;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        
        if (progress >= 100) {
            clearInterval(progressInterval);
        }
    }, 50);
    
    try {
        // Panggil API berdasarkan provider yang dipilih
        const translatedText = await callTranslationAPI(apiProvider, sourceText, sourceLang, targetLang, apiKey);
        
        // Tampilkan hasil
        document.getElementById('target-text').value = translatedText;
        
        // Update status
        document.getElementById('status-bar').textContent = uiTranslations[currentUILang].complete;
    } catch (error) {
        console.error('Translation error:', error);
        document.getElementById('status-bar').textContent = 
            `${uiTranslations[currentUILang].error}: ${error.message}`;
    } finally {
        // Sembunyikan progress bar
        document.getElementById('progress-container').style.display = 'none';
        document.getElementById('translate-btn').disabled = false;
        updateCharCount();
    }
}

function swapLanguages() {
    const sourceLang = document.getElementById('source-language');
    const targetLang = document.getElementById('target-language');
    const sourceText = document.getElementById('source-text');
    const targetText = document.getElementById('target-text');
    
    // Swap values
    [sourceLang.value, targetLang.value] = [targetLang.value, sourceLang.value];
    [sourceText.value, targetText.value] = [targetText.value, sourceText.value];
    
    // Update character count
    updateCharCount();
}

function importText(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('source-text').value = e.target.result;
        updateCharCount();
        document.getElementById('status-bar').textContent = 
            `${uiTranslations[currentUILang].file_loaded} ${file.name}`;
    };
    reader.readAsText(file);
    
    // Reset file input
    event.target.value = '';
}

function exportText() {
    const translatedText = document.getElementById('target-text').value;
    if (!translatedText.trim()) {
        alert(uiTranslations[currentUILang].no_text);
        return;
    }
    
    const blob = new Blob([translatedText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const date = new Date().toISOString().slice(0, 10);
    
    a.href = url;
    a.download = `translated_novel_${date}.txt`;
    a.click();
    
    URL.revokeObjectURL(url);
    document.getElementById('status-bar').textContent = 
        `${uiTranslations[currentUILang].file_saved} translated_novel_${date}.txt`;
}

function clearText() {
    document.getElementById('source-text').value = '';
    document.getElementById('target-text').value = '';
    updateCharCount();
    document.getElementById('status-bar').textContent = uiTranslations[currentUILang].cleared;
}

function showSettings() {
    document.getElementById('settings-modal').style.display = 'block';
}

function closeSettings() {
    document.getElementById('settings-modal').style.display = 'none';
}

function toggleApiKeyVisibility() {
    const apiKeyInput = document.getElementById('api-key');
    const toggleButton = document.getElementById('toggle-api-key');
    
    if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
        toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
        apiKeyInput.type = 'password';
        toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
    }
}
